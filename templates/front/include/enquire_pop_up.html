{% load static %}
<link rel="stylesheet" href="{% static 'front/css/p-14.css' %}" />
<style>
    .enquiry_pop{
        display: none;
        align-items: center;
        justify-content: center;
        padding:  5%;
        position: fixed;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 99999999;
        {% comment %} backdrop-filter: blur(2px); {% endcomment %}
        {% comment %} background-color: rgba(0, 0, 0, 0.9); {% endcomment %}
        background-color: #f7f8f8;
        overflow: scroll;    
    }

   
    .close_pop{
    height: auto;
    width: auto;
    position: fixed;
    right: 50px;
    top: 30px;
    cursor: pointer;
    font-size: 1.5rem;
    z-index: 99;
    }
    .enquiry_pop .alert-danger, .enquiry_pop .alert-success{
        background: transparent;
        padding-left: 0;
        border: 0;
    }
    .enquiry_pop .section-inquiry__container{
        padding: 30px 50px;
        border-radius: 40px;
    }

    @media only screen and (max-width: 768px) {
        .enquiry_pop .section-inquiry__container{
            overflow: scroll;
            padding: 50px  20px;
        }
        .enquiry_pop{
            padding: 0px;     
            overflow: scroll;       
        }
      }
</style>
<div class='enquiry_pop'>
    <i class="fa-solid fa-xmark close_pop"></i>
<section class="section-inquiry">

    {% comment %} <img class='close_pop' src={% static "front/assets/cross-icon.png" %} alt='cross-icon'> {% endcomment %}
   
    <div class=" section-inquiry__container head_anim">
        <h2 class="h1" id="popheading">Order in Bulk</h2>
        {% comment %} <h3>Product Details & Solutions</h3> {% endcomment %}

        <form id="save_lead_form_popup" action={% url 'save_lead' %} method='POST'>
            {% csrf_token %}
            {{leadform.product_id}}
            <input type="hidden" name="page" value="pop"/>
            <div class="section-inquiry__container__form-details">
                <div class="col-1 col">
                    <label for="fname">Name<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.name}}
                </div>
                <div class="col-2 col">
                    <label for="phone">Phone<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.mobile}}
                </div>

                <div class="col-3 col">
                    <label for="email">Email<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.email}}
                </div>
                <div class="col-4 col">
                    <label for="pincode">Pincode<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.zip_code}}
                </div>

                <div class="col-1 col">
                    <label for="city">City<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.city}}
                </div>

                <div class="col-2 col">
                    <label for="state">State<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.state}}
                </div>

                <div class="col-1 col" style="{% if page_name == 'productdetail'%} display:none {%endif%}">
                    <label for="id_category_id">Categories<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.category_id}}
                </div>
                <div class="col-2 col" style="{% if page_name == 'productdetail'%} display:none {%endif%}">
                    <label for="id_sub_category_id">Sub Categories<span style='color: #932f31; font-size:1.5rem;'>*</span></label>
                    {{leadform.sub_category_id}}
                </div>
                <div class="col-7 col">
                    <label for="query">{% if page_name == 'productdetail'%} Query {%else%} Query {%endif%} </label>
                    {{leadform.description}}
                </div>
            </div>

            <button type="button" class="cta savelead_popup" id="savelead_popup">
                <span>Submit</span>
                <svg width="13px" height="10px" viewBox="0 0 13 10">
                    <path d="M1,5 L11,5"></path>
                    <polyline points="8 1 12 5 8 9"></polyline>
                </svg>
            </button>
            

        </form>
        <div class="msg_div"></div>
    </div>
</section>
</div>

<script>

    $('.open_enquire').click(function(){        
        $('.header').css('top', '-90px')
        $('.header').hide()
        open_pop()
    })
    $('.close_pop').click(function(){
        $('.header').css('top', '0px')
        $('.header').show()
        
        close_pop() 
    })

    var pop_div = $('.enquiry_pop')
    var open_pop = ()=> {            
        pop_div.css('display', 'grid')
        $('body').css('overflow', 'hidden')
        $('#popheading').text('Order in Bulk')
        $("#save_lead_form_popup").show();
        $('.alert').remove()        
        $('.enquiry_pop .section-inquiry').css('width', '90vw')
        if(window.innerWidth < 769){
            $('.enquiry_pop .section-inquiry').css('width', '100%')
        }
    }
    var close_pop = ()=> {            
        pop_div.css('display', 'none')
        $('body').css('overflow', 'auto')
        $('#save_lead_form_popup')[0].reset();
    }

    $(document).ready(function () {
        $('#id_category_id').change(function () {
            var category_id = $(this).val();
            $.ajax({
                url: '/sub_category_list',
                type: 'GET',
                data: {'category_id' : category_id},
                success: function(result){
                  result=result.list;
                  $("#id_sub_category_id").html("");
                  $("#id_sub_category_id").append('<option  value="">All Sub Categories</option>');
                  for (var i = result.length - 1; i >= 0; i--) {
                      $("#id_sub_category_id").append('<option value="'+result[i].id+'">'+ result[i].heading +'</option>');
                  };
               },
            });
        });



        $("#id_zip_code").on("change",function(){
         var zip_code =$(this).val();
         var settings = {
            "url": "https://api.postalpincode.in/pincode/"+zip_code,
            "method": "GET",
            "timeout": 0,
          };
          
          $.ajax(settings).done(function (response) {
            response=response[0];
            var Status=response.Status;
            if(Status=="Success"){
                var PostOffice=response.PostOffice;
                var state_name=PostOffice[0].State;
                $("#id_state").val(state_name);
                if(state_name){
                    $('#id_state').prop('readonly', true);
                }
                
            }
            
          });
        }); 

        $(".savelead_popup").on("click", function () {
            var not_filled = 0;
            $('.input').each(function (index, data) {
                if ($(data).val() == '') {
                    $(data).addClass('error');
                    not_filled++;
                } else {
                    $(data).removeClass('error');
                }
            });
            var not_filled = 0;

            // console.log(not_filled);  
            if (not_filled == 0) {
                form = document.getElementById('save_lead_form_popup');
                formdata = new FormData(form);
                $.ajax({
                    url: $("#save_lead_form_popup").attr("action"),
                    type: "POST",
                    enctype: 'multipart/form-data',
                    data: formdata,
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false,
                    beforeSend: function () {
                        $("#savelead_popup").html(`<span>Wait...</span>
                            <svg width="13px" height="10px" viewBox="0 0 13 10">
                                <path d="M1,5 L11,5"></path>
                                <polyline points="8 1 12 5 8 9"></polyline>
                            </svg>`);
                        $("#savelead_popup").removeClass('savelead_popup');
                    },
                    success: function (data) {
                        $("#savelead_popup").html(`<span>submit</span>
                            <svg width="13px" height="10px" viewBox="0 0 13 10">
                                <path d="M1,5 L11,5"></path>
                                <polyline points="8 1 12 5 8 9"></polyline>
                            </svg>`);
                        $("#savelead_popup").addClass('savelead_popup');
                        if (data.error == false) {
                            $('#save_lead_form_popup')[0].reset();
                            var response = "";
                            response += '<div class="alert alert-success" role="alert">' + data.message + '</div>';
                            $("#save_lead_form_popup").hide();
                            $("#popheading").text("Thank You!");
                            $(".msg_div").html(response);
                            $('.enquiry_pop .section-inquiry').css('width', 'fit-content')                            
                            refreshPage();

                        } else {
                            var response = "";
                            var resp = data.errors;
                            if (data.message == '') {
                                $.each(resp, function (k, value) {
                                    response +=
                                        '<div class="alert alert-danger" role="alert">' +
                                        k +
                                        " : " +
                                        value +
                                        `</div>`;
                                });
                            } else {
                                response += '<div class="alert alert-danger" role="alert">' + data.message + '</div>';
                            }
                            $(".msg_div").html(response);
                        }
                    },
                });
            }
        });
    });

    function refreshPage() {
        setTimeout(function() {
            location.reload();
        }, 2000);  // 5000 milliseconds = 5 seconds
    }
</script>